# Contributor <mehdi.chinoune@hotmail.com>

_realname=triton
pkgbase=mingw-w64-python-${_realname}
pkgname=("${MINGW_PACKAGE_PREFIX}-python-${_realname}")
pkgver=3.5.0
pkgrel=1
pkgdesc="A language and compiler for custom Deep Learning operations. (mingw-w64)"
arch=('any')
mingw_arch=('ucrt64' 'clang64' 'clangarm64')
url='https://github.com/triton-lang/triton'
license=('spdx:MIT')
depends=("${MINGW_PACKAGE_PREFIX}-python"
         "${MINGW_PACKAGE_PREFIX}-cc-libs")
makedepends=("${MINGW_PACKAGE_PREFIX}-python-build"
             "${MINGW_PACKAGE_PREFIX}-python-installer"
             "${MINGW_PACKAGE_PREFIX}-python-setuptools"
             "${MINGW_PACKAGE_PREFIX}-pybind11"
             "${MINGW_PACKAGE_PREFIX}-cc"
             "${MINGW_PACKAGE_PREFIX}-cmake"
             "${MINGW_PACKAGE_PREFIX}-ninja"
             "${MINGW_PACKAGE_PREFIX}-nlohmann-json"
             "${MINGW_PACKAGE_PREFIX}-llvm"
             "${MINGW_PACKAGE_PREFIX}-lld"
             "${MINGW_PACKAGE_PREFIX}-mlir")
options=('!strip')
source=("https://github.com/triton-lang/triton/archive/v${pkgver}/${_realname}-${pkgver}.tar.gz"
        https://github.com/triton-lang/triton/commit/deb5dae5.patch
        https://github.com/triton-lang/triton/commit/8af2b7b4.patch
        001-no-nvidia-or-amd.patch)
        #"0001-An-important-fix.patch"
        #"0002-A-less-important-fix.patch")
sha256sums=('SKIP'
            'SKIP'
            'SKIP'
            'SKIP')
            # 'bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb'
            # 'cccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccccc')

prepare() {
  cd "${_realname}-${pkgver}"
  patch -p1 -i "${srcdir}"/deb5dae5.patch
  patch -p1 -i "${srcdir}"/8af2b7b4.patch
  patch -p1 -i "${srcdir}"/001-no-nvidia-or-amd.patch

  sed -i '/requires = \[/s/.*/requires = \["setuptools"\]/' pyproject.toml

  sed -i 's|FileCheck|FileCheck.exe|g' CMakeLists.txt
  sed -i 's|arm64|ARM64|g' CMakeLists.txt

  # patch -Np1 -i "${srcdir}/0001-A-really-important-fix.patch"
  # patch -Np1 -i "${srcdir}/0002-A-less-important-fix.patch"
}

build() {
  cp -r "${_realname}-${pkgver}" "python-build-${MSYSTEM}" && cd "python-build-${MSYSTEM}"

  TRITON_OFFLINE_BUILD=1 \
  TRITON_LLVM_SYSTEM_SUFFIX=${CARCH}-w64-windows-gnu \
  LLVM_SYSPATH=${MINGW_PREFIX} \
  JSON_SYSPATH=${MINGW_PREFIX} \
  python -m build --wheel --skip-dependency-check --no-isolation
}

package() {
  cd "python-build-${MSYSTEM}"

  MSYS2_ARG_CONV_EXCL="--prefix=" \
    python -m installer --prefix=${MINGW_PREFIX} \
    --destdir="${pkgdir}" dist/*.whl

  install -Dm644 LICENSE "${pkgdir}${MINGW_PREFIX}/share/licenses/python-${_realname}/LICENSE"
}
